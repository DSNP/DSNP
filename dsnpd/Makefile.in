# 
#  Copyright (c) 2009, Adrian Thurston <thurston@complang.org>
#
#  Permission to use, copy, modify, and/or distribute this software for any
#  purpose with or without fee is hereby granted, provided that the above
#  copyright notice and this permission notice appear in all copies.
#
#  THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
#  WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
#  MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
#  ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
#  WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
#  ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
#  OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.

LDFLAGS = @LDFLAGS@
CXXFLAGS += -g -Wall

CC_SRCS = main.cpp parser.cpp string.cpp rcfile.cpp encrypt.cpp \
	log.cpp db.cpp dsnp.cpp tls.cpp base64.cpp test.cpp broadcast.cpp queue.cpp \
	friendreq.cpp prefriend.cpp message.cpp network.cpp notification.cpp user.cpp \
	login.cpp flogin.cpp identity.cpp connect.cpp
GEN_SRCS = parser.cpp rcfile.cpp base64.cpp

LIBS = @LIBS@
LIBS += -lcrypto -ldl

#*************************************

DEFS += \
	-DSYSCONFDIR='"@prefix@/etc"' \
	-DLOGDIR='"@prefix@/var/log/dsnp"' \
	-DNOTIFICATION='"php @prefix@/share/dsnp/web/notification.php"' \
	-DPKGSTATEDIR='"@prefix@/var/lib/dsnp"' \
	-DLIBDIR='"@prefix@/lib/dsnp"' \
	-DPREFIX='"@prefix@"'

prefix = @prefix@
datarootdir = @datarootdir@
BUILD_PARSERS = @BUILD_PARSERS@
EXEEXT = @EXEEXT@
CXX = @CXX@

# Get objects and dependencies from sources.
OBJS = $(CC_SRCS:%.cpp=%.o)
DEPS = $(CC_SRCS:%.cpp=.%.d)

# Get the version info.
#include ../version.mk

# Rules.
all: dsnpd

dsnpd: $(GEN_SRCS) $(OBJS)
	$(CXX) $(LDFLAGS) -o $@ $(OBJS) $(LIBS)

parser.cpp: parser.rl
	ragel -G2 -o $@ $<

rcfile.cpp: rcfile.rl
	ragel -G2 -o $@ $<

base64.cpp: base64.rl
	ragel -G2 -o $@ $<

#version.h: ../version.mk
#	echo '#define VERSION "$(VERSION)"' > version.h
#	echo '#define PUBDATE "$(PUBDATE)"' >> version.h
#	echo '#define PREFIX "$(prefix)"' >> version.h

%.o: %.cpp
	@$(CXX) -M $(DEFS) $(INCS) $< > .$*.d
	$(CXX) -c $(CXXFLAGS) $(DEFS) $(INCS) -o $@ $<

distclean: clean
	rm -f Makefile 

clean:
	rm -f tags .*.d *.o dsnpd $(GEN_SRCS)

install: all
	install -d $(DESTDIR)$(prefix)/bin
	install -d $(DESTDIR)$(prefix)/var/log
	install -d $(DESTDIR)$(prefix)/var/log/dsnp
	install -d $(DESTDIR)$(prefix)/var/lib
	install -d $(DESTDIR)$(prefix)/var/lib/dsnp
	install -d $(DESTDIR)$(prefix)/etc/
	install -d $(DESTDIR)$(prefix)/etc/dsnp-ssl
	install dsnpd $(DESTDIR)$(prefix)/bin/dsnpd

-include $(DEPS)
