%
%   Copyright 2001-2009 Adrian Thurston <thurston@complang.org>
%

%   This file is part of Ragel.
%
%   Ragel is free software; you can redistribute it and/or modify
%   it under the terms of the GNU General Public License as published by
%   the Free Software Foundation; either version 2 of the License, or
%   (at your option) any later version.
%
%   Ragel is distributed in the hope that it will be useful,
%   but WITHOUT ANY WARRANTY; without even the implied warranty of
%   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
%   GNU General Public License for more details.
%
%   You should have received a copy of the GNU General Public License
%   along with Ragel; if not, write to the Free Software
%   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA 

% TODO: Need a section on the different strategies for handline recursion.

\documentclass[letterpaper,11pt,oneside]{article}
%\usepackage{graphicx}
\usepackage{comment}
%\usepackage{multicol}
%\usepackage[
%	colorlinks=true,
%	linkcolor=black,
%	citecolor=green,
%	filecolor=black,
%	urlcolor=black]{hyperref}

\topmargin -0.20in
\oddsidemargin 0in
\textwidth 6.5in
\textheight 9in

\setlength{\parskip}{0pt}
\setlength{\topsep}{0pt}
\setlength{\partopsep}{0pt}
\setlength{\itemsep}{0pt}

%% \input{version}
%% 
%% \newcommand{\verbspace}{\vspace{10pt}}
%% \newcommand{\graphspace}{\vspace{10pt}}
%% 
%% \renewcommand\floatpagefraction{.99}
%% \renewcommand\topfraction{.99}
%% \renewcommand\bottomfraction{.99}
%% \renewcommand\textfraction{.01}   
%% \setcounter{totalnumber}{50}
%% \setcounter{topnumber}{50}
%% \setcounter{bottomnumber}{50}
%% 
%% \newenvironment{inline_code}{\def\baselinestretch{1}\vspace{12pt}\small}{}

\begin{document}

%
% Title page
%
\thispagestyle{empty}
\begin{center}
{\huge DSNP: Distributed Social Network Protocol}\\
\vspace*{12pt}
{\Large Specification and Software Documentation}\\
\vspace{12pt}
by\\
\vspace{12pt}
{\large Dr. Adrian D. Thurston}\\
\end{center}

\pagenumbering{roman}

\section*{License}

Copyright \copyright\ 2007-2011 Adrian D. Thurston

\vspace{5pt}

{\bf\it\noindent Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted, provided that the above
copyright notice and this permission notice appear in all copies.}

\vspace{5pt}

{\bf\it\noindent THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.}

\tableofcontents

%
% Chapter 1
%


% Topics:
% RSA Keys allocated to each identity
%
% Broadcast Keys
%
% Properties.
%  Forgery
%  Privacy
%
% Protocol
%  Friendship Initialization

\pagenumbering{arabic}

\section{Introduction}

DSNP is a protocol for distributed social networking. The goal is to allow you
to host your profile with a provider that you choose (possibly yourself), give
you the freedom to maintain control over your personal information, and
interact with your friends and family in a secure manner.

DSNP aims to cover any use case that can be described as first creating a
profile for yourself, establishing connections to people you know, then
broadcasting private information to these people. The information that we share
are the artifacts of our life. No single provider should house this for
everyone.

\subsection{Properties DSNP}

\begin{enumerate}

\item Identities are URI-based.

\item The system is distributed at the level of identities, as opposed to collections
of identities. This means that the authentication and authorization mechanisms
are based on the credentials of the two users that are interacting.

\item There is a single point of login. Once a user has logged into her profile, she is get access to her friend's profiles.

\item DSNP is secure against forgery by non-friends and friends. It is secure against
eavesdropping by non-friends.

\item Allows friendship claims to be verified by trusted third parties. False
friendships can be claimed easily, but they can also be discredited easily.

\item Security does not rely on DNS or SSL alone. If ownership of a domain is lost to
an attacker who is able to secure an SSL cert for the domain, the attacker does
not gain control of the identities on the domain.

\item DSNP allows unfriending. Once a user is unfriended, they no longer have access
to the user's broadcasts, even if they are able to snoop the broadcast traffic.

\item Identities can be exported and migrated to another provider.

\end{enumerate}

\section{Security Model}

DSNP leverages RSA public key cryptography for identity, the sharing of secrets
and the declaration of relationships. It can be described as PGP for web-based
identities, though it does not use PGP. Each identity gets a public/private key
pair. The public portion of the key must be fetched over SSL. By requiring SSL
for public key fetches we eliminate the need for a web of trust. Each public
key is fetched once and trusted from then on.

Use of SSL makes sense for us because it is already need to protect the HTTP
aspect of the system. We simply use the same cert to solve the problem of
securely transmitting public keys.

Since public keys are securely exchanged, direct communication between friends
can be protected in the usual asymmetric manner, where a session key is
encrypted using the peer's public key, then content is encrypted using the
session key.

Messages broadcasted to all friends are handled using a pre-shared broadcast
key. Using a pre-shared key means that messages do not need to crafted for each
recipient. The message can be computed by the sender, stored once, then a copy
sent to each recpient. If desired, messages can be handed to a third party and
delivered on behalf of the user, without the third party being privy to the
message. Only the recipient list is revealed.

Since users can be expected to have very large friend lists, it is desirable to
omit the use of SSL when delivering messages. DNSP allows this, without
explicitly identifying the sender or recipent. Instead, pre-shared relationship
identifiers are transmitted.

When you send messages to your friends, either directly or by broadcast,
messages are also digitally signed with your private key. Your friends can then
use your public key to verify that you wrote the message, uploaded the photo,
commented on someone else's post, etc.

\section{Identity Initialization}

A user name and password is requested. These credentials will be used by the
user to login as the owner of the identity.

A URI consiting of the site root name followed by the user name as the last
component is assigned. This is an internet facing web address that the user has
control of (possibly through a service provider). It represents their identity.

An RSA key pair is created. The key has no passphrase. 

The public portion of the key is made publically available. The key must always
be fetched using SSL. This guarantees that a key has been provided by the
server hosting the identity and has not been tampered with.

\section{Owner Login}

User submits credentials via a web form underneath URI and recieves a session
cookie that indicates to the server that the user is logged in.

\section{Friendship Request}

The person requesting friendship is the friender, with identity URI.
The person who is receiving the request is the friendee, with FR-URI

\begin{enumerate}
\item The friender fills in a friend request form at FR-URI
	\begin{enumerate}
	\item friender answers a challenge (generic CAPTCHA, or personalized)
	\item friender submits URI
	\end{enumerate}

\item Friendee server processes the request:
	\begin{enumerate}
	\item verifies challenge response
	\item fetches the public key for URI (using SSL)
	\item randomly generates a one-way relationship id (REQUESTED-RELID)
	\item randomly generates a one-way request id (REQUESTED-REQID)
	\item encrypts REQUESTED-RELID to friender and signs it
	\item makes message available to be fetched using REQUESTED-REQID to identify it
	\item redirects the user's browser to https://URI/return-relid?uri=FR-URI\&reqid=REQUESTED-REQID
	\end{enumerate}

\item Friender server processes the return-relid request:
	\begin{enumerate}
	\item verifies browser is logged in as owner
	\item fetches public key for FR-URI (using SSL)
	\item fetches encrypted REQUESTED-RELID from FR-URI using REQUESTED-REQID
	\item decrypts and verifies REQUESTED-RELID
	\item randomly generates RETURNED-RELID
	\item randomly generates RETURNED-REQID
	\item encrypts "REQUESTED-RELID RETURNED-RELID" to friendee and signs it
	\item makes message available at to be fetched using RETURNED-REQID to identify it
	\item redirects the friender to https://FR-URI/friend-final?uri=URI\&reqid=REQID
	\end{enumerate}

\item Friendee server processes the friend-final request:
	\begin{enumerate}
	\item fetches encrypted RETURNED-RELID using RETURNED-REQID
	\item decrypts and verifies message, must contain correct REQUESTED-RELID
	\item stores request for friendee to accept/deny
	\end{enumerate}
\end{enumerate}

\section{Friendship Accept/Deny}

The next time the friendee logs in they are presented with the friendship
request. They can either accept or deny the request. 

The acceptor sends accept notification with both relids. They are sent back
indicating that the friendship was registered on the other end. The acceptor
then registers the friendship and sends a registered message. It can can now
send broadcast key and broadcast tree insertion messages. The other end can
send these messages after it receives the registered message.

\section{Publishing to Friends}

\section{Broadcast Encryption Keys}

DSNP uses a broadcast key for encrypting messages broadcast to all friends.
It requires that keys be delivered to friends ahead of time.

Broadcast keys reduce the cost of broadcasting, by allowing a message to be
encrypted only once, then copied to each recipient. Use of SSL for message
delivery is optional. If it is not used, only a relationship identifier is
revealed in the broadcast. This identifier has meaning only to the sender and
recipient. A snooper is able to discover that pairs are repeatedly
communicating, but cannot discover who. This is in contrast with schemes such
as PGP or CMS, where senders and recipients are identified in each
communication.

Use of broadcast keys also allows a third party message broker to deliver
messages on behalf of a user. This feature allows more possible architecture
configurations. One server that is capable of many high-volume transactions can
serve as the message broker for a number of smaller systems.

\section{Roles and Friendship Types}

The different roles poeple play in their lives are often reflected in a
categorization of their relationships. It would be useful in DSNP to support
friendship categories. Each category should have it's own broadcast key and the
distribution trees should not be disconnected. The categories should not
necessarily be comprised of disjoint sets of friends however. Your brother can
be both in your friend category and your family category. You grandmonther,
however, can just be in your family category so you can shelter her from the
details of that crazy weekend in Montreal.

\section{Login as a Friend}

This allows people to login to a friend's page to see the content that has been
summarized by their feed. It is an open-id style login.

User:     URI,    RELID
Friend:   FR-URI, FR-RELID

\begin{enumerate}
\item User fills in a login-as-friend form
	\begin{enumerate}
	\item User visits https://FR-URI/login-as-friend
	\item submits URI
	\end{enumerate}

\item The friend's server processes the request.
	\begin{enumerate}
	\item verifies that URI is a friend
	\item randomly generates a token
	\item encrypts the token to the user and signs it.
	\item makes it available under to be fetched with FR-RELID as identifier
	\item redirects user to https://URI/return-token?uri=FR-URI
	\end{enumerate}

\item  The user's server verifies the user owns the identitiy.
	\begin{enumerate}
	\item checks that FR-URI is a friend
	\item if browser is not logged in, fails the process (possibly with redirect to loging screen)
	\item fetches the token using from FR-URI using FR-RELID to identify it
	\item decrypts and verifies the token
	\item redirects the browser to https://FP-URI/submit-token?uri=URI\&token=TOK
	\end{enumerate}

\item Friend login final
	\begin{enumerate}
	\item Verifies (URI, TOK)
	\item grants friend credentials to the browser using cookie-based session.
	\end{enumerate}
\end{enumerate}

\section{Characteristics}

Your list of friends can be treated as private information. It is impossible
for someone to probe your list of friends if you don't want to publish it.
The list must be explictly granted, even to current friends (see next point
for a minor exception). This makes it possible to partition your
relationships into differnet groups, such as family, close friends,
co-workers, and people you hardly know but might like to get to know better.

The user must trust the server that is hosting their identity. But like email,
blogs, and other forms of internet identity, we are free to choose our service
providers and the truely paranoid and technically inclined are free to host
their own identity on their own server. Perhaps a more difficult problem is
that the user must trust the server that is hosting their friend's identities.
However, this is not a problem unique to DSNP. This is true of email as well.

\section{Notifications}

\begin{itemize}
\item notification\_broadcast           (user message to a group)
\item notification\_message             (user message direct)
\item notification\_remote\_message     (author-subject message to a group)
\item notification\_remote\_publication (author-subject message to the author)
\end{itemize}

\end{document}
